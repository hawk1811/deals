# מערכת ניהול עסקאות ועמלות (Sales and Commission Management System)

מערכת לניהול ומעקב אחר עסקאות, חישוב עמלות והפקת דוחות שכר. המערכת מאפשרת למשתמשים לנהל יעדי מכירות, לעקוב אחר עסקאות, ולחשב עמלות באופן אוטומטי עם תמיכה בסוגים שונים של עסקאות ומודלים של תשלום.

## תוכן עניינים

1. [סקירה כללית](#סקירה-כללית)
2. [הגדרות מערכת](#הגדרות-מערכת)
3. [מבנה קבצים](#מבנה-קבצים)
4. [פונקציות עיקריות](#פונקציות-עיקריות)
5. [ממשק משתמש](#ממשק-משתמש)
6. [מודל נתונים](#מודל-נתונים)
7. [אבטחה](#אבטחה)
8. [התקנה והגדרה](#התקנה-והגדרה)
9. [טיפים ושאלות נפוצות](#טיפים-ושאלות-נפוצות)

## סקירה כללית

המערכת מיועדת לסוכני מכירות, מנהלי צוותי מכירות וארגונים המנהלים תהליכי מכירות על בסיס עמלות. היא מספקת יכולת מעקב אחר עסקאות, חישוב אוטומטי של עמלות בהתאם ליעדים, וחישוב שכר נטו הכולל את כל הניכויים הרלוונטיים.

### תכונות מרכזיות

- ניהול עסקאות ומעקב אחר מכירות לפי חודשים
- חישוב אוטומטי של עמלות על בסיס יעדים שנתיים
- תמיכה במספר סוגי עסקאות (חד-שנתיות, רב-שנתיות, תשלום מראש)
- חישוב שכר נטו כולל כל הניכויים (מס הכנסה, ביטוח לאומי, ביטוח בריאות)
- הצגת סיכומים שנתיים כולל TCV (Total Contract Value) ו-ACV (Annual Contract Value)
- ממשק ניהול למנהל מערכת
- מערכת רספונסיבית המותאמת למכשירים ניידים

## הגדרות מערכת

### דרישות טכניות

- PHP 7.3 ומעלה
- גישה לקבצי JSON (לאחסון נתונים)
- עיבוד SSL/TLS (מומלץ להגנה על הנתונים)

### ארכיטקטורה

המערכת בנויה בארכיטקטורת LAMP (Linux, Apache, MySQL/JSON files, PHP) עם אחסון נתונים מבוסס-קבצים בפורמט JSON. כל נתוני המשתמשים מוצפנים בהצפנת AES-256 להגנה על המידע.

## מבנה קבצים

```
מערכת/
├── assets/
│   ├── css/
│   │   └── main.css            # קובץ CSS ראשי כולל עיצוב למובייל
│   └── js/
│       ├── main.js             # פונקציות JavaScript כלליות 
│       └── tax_editor.js       # פונקציות JavaScript לעורך המס
├── data/
│   ├── logs/                  # יומני מערכת
│   ├── tax_years/             # נתוני מיסוי לפי שנים
│   └── users_data/            # נתוני משתמשים מוצפנים
├── includes/
│   ├── auth.php               # פונקציות אימות והרשאות
│   └── functions.php          # פונקציות ליבה של המערכת
├── admin_dashboard.php        # לוח בקרה למנהל
├── change_password.php        # עמוד שינוי סיסמה
├── dashboard.php              # דף הפניה ללוח הבקרה המתאים
├── delete_transaction.php     # עיבוד מחיקת עסקה
├── edit_transaction.php       # עריכת עסקה קיימת
├── index.php                  # דף כניסה למערכת
├── tax_editor_modal.php       # חלונית עריכת נתוני מס
├── tax_management.php         # ניהול נתוני מיסוי
├── update_tax_data.php        # עיבוד עדכון נתוני מס
├── user_dashboard.php         # לוח בקרה למשתמש רגיל
└── user_management.php        # ניהול משתמשים
```

## פונקציות עיקריות

### מודל חישוב עמלות

המערכת מיישמת מודל חישוב עמלות מורכב המתייחס למספר פרמטרים:

1. **סוגי עסקאות**:
   - עסקאות לשנה אחת - העמלה מחושבת על הסכום המלא
   - עסקאות רב-שנתיות עם תשלום מראש - העמלה מחושבת על הסכום המלא
   - עסקאות רב-שנתיות ללא תשלום מראש - העמלה מחושבת באופן מדורג:
     - שנה ראשונה: עמלה מלאה על החלק היחסי
     - שנים נוספות: חצי עמלה על החלק היחסי

2. **חישוב ביחס ליעד**:
   - עסקאות עד היעד: `(סכום העסקה / יעד שנתי) × עמלה שנתית`
   - עסקאות מעל היעד: `(סכום העסקה / יעד שנתי) × עמלה שנתית × 1.5`
   - עסקאות החוצות את היעד: מפוצלות לשני חלקים לפי היחס המתאים

לוגיקה זו מיושמת בפונקציה `calculateCommission()` בקובץ `functions.php`.

### מדדי ביצוע מרכזיים

המערכת מציגה מספר מדדי ביצוע מרכזיים:

- **TCV (Total Contract Value)**: סך כל ערכי החוזים, כולל ערך לכל אורך חיי העסקה
- **ACV (Annual Contract Value)**: ערך חוזה שנתי, המתייחס לחלק היחסי לשנה הראשונה בלבד
- **אחוז מהיעד**: מציג את היחס בין ה-ACV ליעד השנתי כאחוז
- **עמלות**: סך כל העמלות שחושבו על כל העסקאות

### חישוב שכר ומיסוי

המערכת כוללת לוגיקה מפורטת לחישוב שכר נטו על בסיס:

- שכר בסיס
- החזר רכב
- עמלות
- מדרגות מס הכנסה
- נקודות זיכוי
- ביטוח לאומי
- מס בריאות
- הפרשות פנסיה
- קרן השתלמות

חישובים אלו מיושמים בפונקציה `calculateNetSalaryNew()` בקובץ `functions.php`.

## ממשק משתמש

### לוח בקרה למשתמש

קובץ: `user_dashboard.php`

הלוח בקרה למשתמש מציג:
- סיכום שנתי עם מדדי ביצוע מרכזיים (TCV, ACV, יעד, עמלות)
- הצגת עסקאות לפי חודשים
- אפשרות להוספת, עריכת ומחיקת עסקאות
- חישוב שכר חודשי כולל פירוט ניכויים
- הגדרות משתמש אישיות

#### פילטרים וסינון

- ניתן לסנן ולהציג רק עסקאות רב-שנתיות שאינן משולמות מראש באמצעות הכפתור "הצג רק עסקאות רב-שנתיות ללא תשלום מראש"

### לוח בקרה למנהל

קובץ: `admin_dashboard.php`

הלוח בקרה למנהל מספק:
- סיכום מידע על המערכת (מספר משתמשים, שנות מס)
- גישה לניהול משתמשים
- גישה לניהול נתוני מיסוי
- הצגת יומן פעולות המערכת
- אפשרות ייצוא לוגים לקובץ CSV

### ניהול משתמשים

קובץ: `user_management.php`

מאפשר למנהל המערכת:
- הוספת משתמשים חדשים
- מחיקת משתמשים
- איפוס סיסמאות
- הגדרת הרשאות (משתמש רגיל/מנהל)
- הגדרת כינויים למשתמשים

### ניהול נתוני מיסוי

קובץ: `tax_management.php`

מאפשר למנהל המערכת לערוך:
- מדרגות מס הכנסה
- ערכי נקודות זיכוי
- מדרגות ביטוח לאומי
- מדרגות מס בריאות
- תקרות הפרשה פטורות ממס

## מודל נתונים

### מבנה נתוני עסקה

```javascript
{
  "client_name": "שם הלקוח",
  "description": "תיאור העסקה",
  "duration_years": 2,            // תקופת העסקה בשנים
  "duration_months": 24,          // לתאימות לאחור
  "amount": 10000,                // סכום העסקה בדולרים
  "is_prepaid": true,             // האם משולמת מראש
  "date_added": "2025-01-01 12:00:00",
  "total_at_add_time": 50000,     // סך העסקאות בזמן ההוספה
  "commission": 500               // העמלה המחושבת בש"ח
}
```

### מבנה הגדרות שנה למשתמש

```javascript
{
  "base_salary": 10000,           // שכר בסיס בש"ח
  "car_allowance": 1000,          // החזר רכב בש"ח
  "yearly_target": 100000,        // יעד שנתי בדולרים
  "yearly_commission": 10000,     // עמלה שנתית בש"ח
  "tax_credit_points": 2.5,       // נקודות זיכוי
  "pension_rate": 6,              // אחוז הפרשה לפנסיה
  "hishtalmut_rate": 2.5          // אחוז הפרשה לקרן השתלמות
}
```

### מבנה נתוני מיסוי

```javascript
{
  "income_tax_brackets_monthly": [
    {
      "bracket": 1,
      "min_income": 0,
      "max_income": 7010,
      "tax_rate": 0.1
    },
    // מדרגות נוספות...
  ],
  "tax_credit_point": {
    "monthly_value": 242,
    "annual_value": 2904
  },
  "national_insurance": {
    "brackets": [
      // מדרגות ביטוח לאומי...
    ],
    "max_income_ceiling": 50695
  },
  "health_insurance": {
    "brackets": [
      // מדרגות מס בריאות...
    ],
    "max_income_ceiling": 50695
  },
  "education_fund": {
    "tax_exempt_ceiling": 15712
  }
}
```

## אבטחה

### הצפנת נתונים

כל הנתונים האישיים של המשתמשים מוצפנים באמצעות:
- הצפנת AES-256-CBC
- מפתחות ייחודיים לכל משתמש המבוססים על שם המשתמש והסיסמה
- ווקטורי אתחול (IV) ייחודיים לכל הצפנה

פונקציות ההצפנה והפענוח נמצאות בקובץ `functions.php`:
- `encryptData()`
- `decryptData()`
- `getUserEncryptionKey()`

### אימות והרשאות

מערכת האימות וההרשאות מיושמת בקובץ `auth.php`:

- `authenticateUser()` - אימות פרטי משתמש
- `isAdmin()` - בדיקת הרשאות מנהל
- `requireLogin()` - אכיפת התחברות
- `requireAdmin()` - אכיפת הרשאות מנהל
- `validateCSRFToken()` - הגנה מפני התקפות CSRF

## התקנה והגדרה

1. **העלאת הקבצים לשרת**:
   - העתק את כל קבצי המערכת לתיקיית השרת

2. **הגדרת הרשאות**:
   - ודא שהתיקיות `data` וכל תיקיות המשנה שלה ניתנות לכתיבה (777 או 755 בהתאם להגדרות השרת)

3. **גישה ראשונית**:
   - גש לכתובת האתר בדפדפן
   - התחבר עם פרטי המשתמש הראשוניים:
     - שם משתמש: `admin`
     - סיסמה: `password`
   - תתבקש לשנות את הסיסמה בכניסה הראשונה

4. **ניהול משתמשים וסיסמאות**:
   - סיסמת ברירת המחדל לכל המשתמשים החדשים היא `password`
   - כל משתמש חדש (כולל מנהל המערכת בכניסה הראשונית) נדרש להחליף את הסיסמה בכניסה הראשונה
   - בעת איפוס סיסמה, הסיסמה מתאפסת ל-`password` ונדרש לשנותה בכניסה הבאה

5. **הגדרת המערכת**:
   - צור משתמשים נוספים דרך ממשק ניהול המשתמשים
   - הגדר את נתוני המיסוי דרך ממשק ניהול המיסוי
   - הגדר שנים נוספות לפי הצורך

## טיפים ושאלות נפוצות

### חישוב TCV מול ACV

- **TCV (Total Contract Value)**: מייצג את הערך המלא של כל העסקאות לכל תקופת החוזה
- **ACV (Annual Contract Value)**: מייצג את הערך השנתי, המחושב באופן הבא:
  - עסקאות לשנה אחת: 100% מהסכום
  - עסקאות רב-שנתיות עם תשלום מראש: 100% מהסכום
  - עסקאות רב-שנתיות ללא תשלום מראש: הסכום המלא מחולק במספר השנים

### טיפים לניהול עסקאות

1. **עסקאות רב-שנתיות**: 
   - אם העסקה משולמת מראש, סמן את האפשרות "משולמת מראש" כדי לקבל עמלה מלאה על הסכום המלא
   - אם העסקה משולמת לאורך זמן, השאר את הסימון כבוי לחישוב מדויק יותר

2. **מעקב אחר יעדים**:
   - היעדים נקבעים על בסיס שנתי
   - עסקאות מעל היעד מזכות בעמלה מוגדלת (×1.5)
   - עקוב אחר "אחוז מהיעד" כדי לראות את מצב ההתקדמות

### שיקולי אבטחה

1. **סיסמאות**:
   - שנה סיסמאות תקופתית
   - בחר סיסמאות חזקות (8 תווים לפחות)
   - בעת איפוס סיסמה למשתמש, המשתמש יידרש להחליף את הסיסמה בכניסה הבאה

2. **גיבוי נתונים**:
   - מומלץ לגבות את תיקיית `data` באופן קבוע
   - שמור את קבצי הגיבוי במיקום מאובטח

### התאמות לתצוגה במכשירים ניידים

המערכת מותאמת למכשירים ניידים, עם התאמות מיוחדות:
- מבנה טבלאות מפושט עם הסתרת עמודות פחות חשובות
- כפתורים גדולים יותר לממשק מגע
- סידור אנכי של אלמנטים במקום אופקי
- התאמות גודל טקסט וריווח לקריאה נוחה במסך קטן

---

© 2025 מערכת ניהול עסקאות ועמלות. כל הזכויות שמורות.
